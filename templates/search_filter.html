{% extends "base.html" %}
{% block content %}
<h2>Search & Filter</h2>
<form method="POST" id="search-form">
  {{ form.hidden_tag() }}  <!-- âœ… CSRF token included -->
  <div class="mb-2">
    {{ form.keyword(class="form-control", placeholder="Region keyword", id="region-input") }}
  </div>
  <div class="mb-2">
    {{ form.area_min(class="form-control", placeholder="Min Area") }}
  </div>
  <div class="mb-2">
    {{ form.area_max(class="form-control", placeholder="Max Area") }}
  </div>
  {{ form.submit(class="btn btn-primary") }}
</form>
<div id="suggestions" class="mt-2" style="display:none;">
  <ul class="list-group"></ul>
</div>
{% if result is not none %}
  <h4 class="mt-3">Results:</h4>
  {{ result.to_html(classes="table table-striped", index=False) | safe }}
  <a href="{{ url_for('export') }}" class="btn btn-success mt-2">Export to CSV</a>
{% endif %}
<script>
  // JavaScript for dynamic region search
  const regionInput = document.getElementById("region-input");
  const suggestionsBox = document.getElementById("suggestions");
  const suggestionsList = suggestionsBox.querySelector("ul");
  regionInput.addEventListener("input", function() {
    const query = regionInput.value.trim().toLowerCase();
    if (query.length > 0) {
      fetch(`/search/regions?keyword=${query}`)
        .then(response => response.json())
        .then(data => {
          // Clear previous suggestions
          suggestionsList.innerHTML = '';
          suggestionsBox.style.display = 'block';
          // Display new suggestions if any
          if (data.length > 0) {
            data.forEach(region => {
              const listItem = document.createElement("li");
              listItem.classList.add("list-group-item");
              listItem.textContent = region;
              suggestionsList.appendChild(listItem);

              // Add click event to add the region to the input field
              listItem.addEventListener("click", () => {
                regionInput.value = region;
                suggestionsBox.style.display = 'none'; // Hide suggestions
              });
            });
          } else {
            suggestionsList.innerHTML = '<li class="list-group-item">No regions found</li>';
          }
        });
    } else {
      suggestionsBox.style.display = 'none';
    }
  });

  // Close the suggestions box if clicked outside
  document.addEventListener("click", function(event) {
    if (!suggestionsBox.contains(event.target) && event.target !== regionInput) {
      suggestionsBox.style.display = 'none';
    }
  });
</script>
{% endblock %}